**************************************************************************
* PBONUS_TYPE.PRG - справочник типов бонусов от поставщиков
* Создано: 10.02.2011
* Последнее изменение: 08.03.2011
* Автор: Бринк С.
**************************************************************************
PUBLIC MySubDir
MySubDir="PBONUS"

* задаю относительные места "лежания" компонент программы
SET PATH TO MySubDir+"\" ADDITIVE
SET PATH TO MySubDir+"\VCL\" ADDITIVE
SET PATH TO MySubDir+"\ICONS\" ADDITIVE

* подключаю файдик со списком общих для всей проги процедур и функций
SET PROCEDURE TO MySubDir+"\pbonus_common.prg" ADDITIVE
*SET CLASSLIB TO MySubDir+"\VCL\SendEmail" ADDITIVE

PUBLIC CursorName, CursorTmpName, CursorLockName, CursorUserName
CursorName=fCreateCursorName('pbt')
CursorTmpName=fCreateCursorName('_pbt')
CursorLockName=fCreateCursorName('_lock')
CursorUserName=fCreateCursorName('_user')

* имя основной таблицы
* используется при идентификации в функциях MyCheckRLOCK, MyRLock, MyRUnLock
* и при удалении строк в pbonus_del.scx 
PUBLIC MainTableName
MainTableName="pbonus_type"

* имя и код текущего пользователя
PUBLIC M.CUser_Name, M.CUser_Code
M.CUser_Code=gnuser						&& переменная идентификатор кода текущего пользователя из СВ, для надежности (вдруг поменяют ...) сохраняю в своей переменной
M.CUser_Name=ALLTRIM(SUBSTR(GetUserData(M.CUser_Code,1,.F.),9))

* вынимаю из файла настроек пользовтелей все настройки и права
*PUBLIC pnFltPri, pnFltOtm, plFltDraft, M.CUser_Co
*=GetUserPresets(M.CUser_Code,'USER')

* команды для выборки, добавления и обновления строки в основную таблицу
PUBLIC sqlSelectStatement, sqlLineSelectStatement, sqlInsertStatement, sqlUpdateStatement, sqlManyDeleteStatement, sqlOneDeleteStatement, sqlUnDeleteStatement

sqlSelectStatement="SELECT * FROM "+MainTableName
				   
sqlLineSelectStatement=sqlSelectStatement+" WHERE "+MainTableName+".code=?m.code"
					 
sqlInsertStatement="INSERT INTO "+MainTableName+;
						  " (pbt_name,pbt_sb,pbt_pb,pbt_comm,deleted) "+;
			  	   "VALUES(?m.pbt_name,?m.pbt_sb,?m.pbt_pb,?m.pbt_comm,?m.deleted)"
		 	  
sqlUpdateStatement="UPDATE "+MainTableName+" "+;
				   "SET pbt_name=?m.pbt_name,pbt_sb=?m.pbt_sb,pbt_pb=?m.pbt_pb,pbt_comm=?m.pbt_comm "+;
				   "WHERE code=?m.code"
			 	  
sqlManyDeleteStatement="UPDATE "+MainTableName+" SET DELETED=1"

sqlOneDeleteStatement=sqlManyDeleteStatement+" WHERE code=?m.code"

sqlUnDeleteStatement="UPDATE "+MainTableName+" SET DELETED=0 WHERE code=?m.code"

**** добавляю поля при разработке *********************************
*=RunSQL("ALTER TABLE pbonus_type ADD pbt_comm CHAR (150) ", CursorName)
*=RunSQL("ALTER TABLE pbonus_type ALTER COLUMN pbt_comm CHAR (150) ", CursorName)
*=RunSQL("ALTER TABLE pbonus_user ADD pau_fotm INT ", CursorName)
*=RunSQL("ALTER TABLE pbonus_user ADD pau_fdra BIT NULL", CursorName)
*lnRunResult = RunSQL("SELECT pbonus_user.*, password.name FROM pbonus_user LEFT JOIN password ON pbonus_user.upcode= password.code", CursorName)
*DISPLAY STRUCTURE
*BROWSE
*USE
*******************************************************************

* проверяю права на доступ
pnUserCheck=0
pnUserCheck=CheckPBonusUser(M.CUser_Code,'PBonusType')
IF  pnUserCheck = 1
	DO FORM PBT_LST.scx 	&& вызываю экранную форму
ELSE
	WAIT WINDOW 'У вас нет доступа в данный раздел!'	
ENDIF	




